<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<script src="lib/jquery.min.js"></script>
 	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>CTScan Compare</title>

	<style type="text/css">
		 
		 body { 			font-family: Verdana,Geneva,sans-serif; font-size:13px; box-sizing: border-box;
							padding: 0px; margin: 0px; 
							}
		.ct-mainPanel {		background-color:#eee; border-radius: 6px; margin-top: 16px; padding: 12px; max-width: 1000px;
							margin-left: auto; margin-right: auto; opacity: 0;
							}
		.ct-chartPanel {	background-color:#fff; margin-top: 16px; opacity: 0; 
							font-size: 12px; padding-bottom:0px; border-radius: 6px;
							}
		.ct-chart {			display: inline-block; width:100%;
							}
		.ct-dataPanel {		background-color:#fff; max-width:1000px; margin-left: auto; margin-right: auto; opacity: 0; 
							max-height: 2000px;  overflow-y:auto;
							}
		.ct-is 	{			border-radius:4px; padding-left:8px; border: 1px solid #999; margin-bottom: 3px;
							}
		.ct-unselectable { 	-moz-user-select: none;     -khtml-user-select: none;
		   			 		-webkit-user-select: none;  -ms-user-select: none;   user-select: none;
		   					}

</style>
</head>
<body>
	<div id="mainPanel" class="ct-mainPanel">
		<div style="text-align:center">
		<div class="ct-unselectable">
			<img src="img/ctlogo32.png"><br>
			<b>Classroom Teaching Scan Compare</b></div><br>
		</div>
		<div id="chartPanel" class="ct-chartPanel">
			<div class="ct-chart" id="chart1Chart"></div>
		</div>
		<br>
		Compare this session with session: <select id="compGrade" class="ct-is"><option>in all grades</option><option>in this grade only</option></select>&nbsp;&nbsp;
		<select id="compSubject" class="ct-is"><option>for all subjects</option><option>for this subject only</option></select>&nbsp;&nbsp;
		<select id="compSetting" class="ct-is"><option>in all settings</option><option>in this setting only.</option></select>&nbsp;
        or just this Id:&nbsp;<input id="compId" class="ct-is" style="width:30px"/></td></tr>
	</div>
	<div id="dataPanel" class="ct-dataPanel"></div>

<script>

//////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

var curJson=null;															// Holds session results
var sessionNum=28;															// Session index
var obsEvents=null;															// Points at events
var maxTime=0;																// Size of timeline
var svgNS="http://www.w3.org/2000/svg";										// Name space
var menuFile="menus.txt";													// Memu filename
var scaleSpan=128;															// Scaling
var dataMedia=[];															// Holds media buttons											
var dataLabVals=[];															// Holds OTR button values											
var dataLabCats=[];															// Holds OTR button categories											
var dataActs=[];															// Holds media buttons											
var dataAcad=[];															// Holds academic diciplines
var menus=[];																// Holds menus
var butCts=[];																// Button counts

$(document).ready(function() {								           	// ON PAGE LOADED

	var url=window.location.search.substring(1);							// Get query string
	if (url) {																// If something	
		sessionNum=url;														// Get session id
		}
	document.title+=" ("+sessionNum+")";									// Add id to title		
	
	Query("id = '"+sessionNum+"'", function(d) { 						// Send query
		if (!d || d == "null")											// No hits													
			return;;													// Quit
		curJson=$.parseJSON(d)[0];										// Objectify result
		Start();														// Start timeline
		});

		$("#compSubject").on("change", function(e) {						// ON SUBJECT CHANGE
			GetObservations("subject");										// Show matching observations
			});													
		$("#compSetting").on("change", function(e) {						// ON SETTING CHANGE
			GetObservations("setting");										// Show matching observations
			});													
		$("#compGrade").on("change", function(e) {							// ON GRADE CHANGE
			GetObservations("grade");										// Show matching observations
			});													
		$("#compId").on("change", function(e) {								// ON ID CHANGE
			GetObservations("id");											// Show matching observations
			});													
		
});																			// On ready

	function Start()
	{
		var i;
		obsEvents=$.parseJSON(curJson.events);								// Objectify events
		for (i=0;i<dataLabVals.length;++i)									// For each event button
			butCts[dataLabVals[i]]=0;										// Null each one
		
		for (i=0;i<obsEvents.length;++i) {									// For each event
			if (obsEvents[i].time-0 > maxTime)								// If a longer time
				maxTime=obsEvents[i].time-0;								// Use it
			if (obsEvents[i].d1 == "Event") 								// An event
				butCts[obsEvents[i].d3]++;									// Add to count
			}
	 	ShowData();															// Show data
 		GetObservations();
 	 }

	function GetObservations()											// GET SELECTED OBSERVATIONS FROM DB
	{
		Sound("click");														// Click sound	
		var sub=$("#compSubject").val();									// Get subject
		var set=$("#compSetting").val();									// Get setting
		var gra=$("#compGrade").val();										// Get grade
		var id=$("#compId").val();											// Get id
		var q="SELECT id FROM sessions WHERE id != '0'";					// Query base 
		if (sub.match(/this/)) 												// Just looking for this subject							
			q+=" AND subject LIKE '%"+curJson.subject+"%'"; 				// Add to query				
		if (set.match(/this/)) 												// Just looking for this setting							
			q+=" AND setting LIKE '%"+curJson.setting+"%'"; 				// Add to query				
		if (gra.match(/this/)) 												// Just looking for this grade							
			q+=" AND grade LIKE '%"+curJson.grade+"%'"; 					// Add to query				
		if (id)																// If an id spec's
			getTheData([id]);												// Get the data on that id																
		else
			Query(q, function(d) { 											// Send query
				var i,str,ids=[];
				if (!d || d == "null")										// No hits													
					return;													// Quit
				d=$.parseJSON(d);											// Objectify result
				for (i=0;i<d.length;++i)									// For each result
					ids.push(d[i].id);										// Add to array
				getTheData(ids);											// Send list of ids
				});

		function getTheData(ids)											// GET THE DATA
		{
			trace(ids)
			google.charts.load('current', {'packages':['corechart']});		// Load chart library
			google.charts.setOnLoadCallback(DrawChart1);					// Draw chart 1
			$("#mainPanel").animate({ opacity:1 },1500);					// Show main
			$("#chartPanel").animate({ opacity:1 },1500);					// Show charts
			$("#dataPanel").animate({ opacity:1 },1500);					// Show data
			}
	}

	function ShowData()													// SHOW DATA
	{
		var i,o,str="<br>";
		str+="<div style='display:inline-block;margin-right:32px;vertical-align:top'><table>"
		str+="<tr><td style='width:100px'><b>Session Id:</b></td><td>"+curJson.id+"</td></tr>";
		str+="<tr><td><b>Observer:</b></td><td>"+curJson.obs+"</td></tr>";
		str+="<tr><td><b>Email:&nbsp;&nbsp;</b></td><td>"+curJson.email+"</td></tr>";
		str+="<tr><td><b>Teacher Id:</b></td><td>"+curJson.teacherId+"</td></tr>";
		str+="<tr><td><b>Grade:</b></td><td>"+curJson.grade+"</td></tr>";
		str+="</table></div>";
		
		str+="<div style='display:inline-block;margin-right:32px;vertical-align:top'><table>"
		str+="<tr><td style='width:100px'><b>Subject:</b></td><td>"+curJson.subject+"</td></tr>";
		str+="<tr><td><b>Date:</b></td><td>"+curJson.date+"</td></tr>";
		str+="<tr><td><b>Block:</b></td><td>"+curJson.block+"</td></tr>";
		str+="<tr><td><b>Setting:</b></td><td>"+curJson.setting+"</td></tr>";
		str+="<tr><td><b>Video:</b></td><td>"+curJson.video+"</td></tr>";
		str+="</table></div>";
		
		str+="<div style='display:inline-block;margin-right:32px;vertical-align:top'><table>"
		str+="<tr><td style='width:100px'><b>Reminder:</b></td><td>"+curJson.remind+"</td></tr>";
		str+="<tr><td><b>Research:</b></td><td>"+curJson.research+"</td></tr>";
		str+="<tr><td><b>Template:</b></td><td>"+curJson.template+"</td></tr>";
		str+="</table></div>";
		$("#dataPanel").append(str);										// Add to panel	
	}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CHARTS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


    function DrawChart1() 												// DRAW CHART 1
	{
		var i,d=[];
		var data=new google.visualization.DataTable();						// Make new table
		data.addColumn('string', 'Label');									// Add label column
 		data.addColumn('number', 'Time');									// Add time
	    var data = google.visualization.arrayToDataTable([
          ['', 'This session', 'All sessions', 'With others'],
          ['Ratio of this to that', 100, 40, 20],
          ['All markers used', 89, 46, 30],
          ['Student engagement', 66, 56, 40],
          ['Teacher engagement', 19, 12, 80],
	      ['Time on task', 99, 72, 60]
          ]);

		var options={														// Set options
			seriesType: 'bars',
			chartArea:{ left:32, top:16, width:"80%" }
			};
 
 	   	var chart=new google.visualization.ComboChart(document.getElementById('chart1Chart'));
  		chart.draw(data,options);
  	}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function Query(query, callback) 
	{
		var dat={ q:query.replace(/'/g,"~") };
		var url="//classroomteachingscan.com/ctscan/query.php";				// Target
		$.ajax({ url:url,dataType:'text',type:"GET",crossDomain:true,data:dat,  // Get data
			success:function(d) { callback(d) },							// Run callback				
			error:function(xhr,status,error) { trace(error) },				// Show error
			});		
	}
		
	function ShortenString(str, len)									// SHORTEN A STRING TO LENGTH
	{
		if (!len)															// No length
			return "";														// Return null
		if (str && str.length > len)										// Too long
			str=str.substr(0,(len-3)/2)+"..."+str.slice((len-3)/-2);		// Shorten	
		return str;															// Return string
	}

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function Sound(sound, mute)												// PLAY SOUND
	{
		var snd=new Audio();													// Init audio object
		if (!snd.canPlayType("audio/mpeg") || (snd.canPlayType("audio/mpeg") == "maybe")) 
			snd=new Audio("img/"+sound+".ogg");									// Use ogg
		else	
			snd=new Audio("img/"+sound+".mp3");									// Use mp3
		if (!mute)	{															// If not initing or muting	
			snd.volume=50/100;													// Set volume
			snd.play();															// Play it
			}
		}
	
</script>
</body>
</html>
