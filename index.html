<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="css/jquery-ui.min.css"></link>
	<script src="lib/jquery.min.js"></script>
	<script src="lib/jquery-ui.min.js"></script>
	<!-- script src="lib/jquery.ui.touch-punch.min.js"></script -->
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>CTScan</title>
	<style type="text/css">
		 body { 			font-family: Verdana,Geneva,sans-serif; font-size:13px; box-sizing: border-box;
							padding: 0px; margin: 0px; 
							}
		.ct-splash { 		position: absolute; top:50px; left: calc(50% - 100px); opacity:0;
							font-size: 20px; text-align: center; font-weight: bold;
							}
		.ct-obsPanel {		background-color:#ddd; border-radius: 6px; margin: 24px; padding: 12px; width: 618px;
							margin-left: auto; margin-right: auto; opacity: 0; 
							}
		.ct-obsCat {		font-size: 20px; font-weight: bold; color: #333; margin-bottom: 4px;
							display: inline-block; user-select: none; 
							}
		.ct-obsTime {		font-size: 20px; border-radius: 6px; background-color: #fff; text-align: center; width: 110px; float: right;
							border: 1px solid #ccc; color: #666; user-select: none; margin-bottom: 8px;
							}
		.ct-obsStart {		cursor: pointer; width: 14px; margin-left: 8px; margin-right: 8px; float:right; margin-top: 3px;
							}
		.ct-obsPrac {		cursor: pointer; vertical-align: -6px; margin-left: 67px; 
							}
		.ct-obsPracText {	font-size: 12px; color:#000; font-weight: bold; margin-bottom: 8px; 
							user-select: none;
							}
		.ct-obsNewPrac {	cursor: pointer; color:#fff; 
							text-align: center; border-radius: 6px; display: inline-block; user-select: none;
							font-size: 12px; background-color: #27ae60; padding: 2px 8px 2px 8px; vertical-align:3px;
							}
		.ct-obsPracList {	font-size: 13px; user-select: none; overflow-x:hidden; overflow-y: auto; height: 100%
							}
		.ct-obsPracItem {	cursor: pointer; padding:1px;
							}
		.ct-obsPracItem:hover {	 background-color:#ccc;
							}
		.ct-obsPracSubs	{ 	width: 250px; font-weight: normal; cursor: pointer; display: inline-block; color:#666;
							margin-left: 25px;
							}
		.ct-obsDone {		cursor: pointer; color:#fff; text-align: center; border-radius: 6px; display: inline-block; user-select: none;
							font-size: 12px; background-color:#e74c3c; padding: 2px 8px 2px 8px;
							}
		.ct-obsEvtBut {		width: 80px; height: 60px;  margin-bottom: 8px; cursor: pointer; color:#fff; 
							text-align: center; border-radius: 6px; display: inline-block; user-select: none;
							padding-top:8px; font-size: 14px; margin-right:4px; background-color:#aaa;
							}
		.ct-obsEvtBut:hover { opacity : .75
							}
		.ct-count {			cursor: zoom-out;
							}
		.ct-count:hover {	color: #333;
							}
		.ct-mediarow {		width:280px;
							}
		.ct-mediaNotes 	{	margin-top: 8px; margin-bottom: 6px; user-select: none;
							}
		.ct-notes 	{		width: 560px; border-radius:4px; padding-left:8px; border: 1px solid #999;
		 					margin-top: 8px; margin-bottom: 6px;
							}
		.ct-notesBut {		cursor: pointer; color:#fff; text-align: center; border-radius: 6px; display: inline-block;
							margin-top: 2px; margin-left:4px; user-select: none; font-size: 10px; 
							padding-bottom: 2px; padding-left: 6px; padding-right: 6px; background-color:#27ae60
							}
		.ct-is 	{			border-radius:4px; padding-left:8px; border: 1px solid #999; margin-bottom: 3px;
							}

		.ct-dialogTitle {	font-size: 20px; font-weight: bold; color: #000; margin-bottom: 8px; user-select: none;
							}
		@media only screen and (max-height: 525px) {	.ct-obsPanel {	margin-top: 0; margin-bottom: 0   }		}

		.ui-dialog-buttonpane.ui-widget-content.ui-helper-clearfix { border:none }
		.ui-dialog { border-radius:6px; background-color:#ddd }
		.ui-button { border-radius:30px;outline:none }
		.ui-dialog-titlebar { display:none }
		 table {			border-spacing: 0px;  }
		 input {		    vertical-align: -2px; }

</style>
</head>
<body>
	<div id="splashDiv" class="ct-splash"><img src="img/ctlogo400.png" width="200"><br>
		<br>Classroom Teaching<br>Scan<br><br>
		<span style="font-size:14px;font-weight:normal">
			Michael J. Kennedy<br>Wendy J. Rodgers, and John E. Romig<br><br>
			<b>Curry School of Education<br>University of Virginia</b>
			<br>&copy; 2017
			<br>v2.0<br><br>
			<div id="startIt" class="ct-obsNewPrac">Click to continue</div><br>
		</span>
	</div>
	<div id="obsPanel" class="ct-obsPanel">
		<div id="obsNewCat"  class="ct-obsNewPrac">Set</div>
		<div id="obsCat" class="ct-obsCat">No category chosen yet...</div>&nbsp;&nbsp;
		<div id="obsTimerText" class="ct-obsTime">00:00</div>
		<img id="obsStart" src="img/playbut.png" class="ct-obsStart">
		<div class="ct-obsPracText" id="obsPracText" ></div><div id="obsNewPrac" class="ct-obsNewPrac">Add new practice</div><br>
		<hr style="margin-bottom:8px;margin-top:10px">
		Add Vocab Term or Topic: <input class="ct-is" id="newTerm" type="text" placeholder="Type new term here"></input>	
		<div id="sendTerm" class="ct-notesBut">Add</div>
		<div id="vocabTerms"></div>
		<hr style="margin-bottom:8px">
		<div>
			<div id="ev-1" class="ct-obsEvtBut"><span id="evl-1"></span><span class="ct-count" id="evc-1"><br></span></div> 
			<div id="ev-2" class="ct-obsEvtBut"><span id="evl-2"></span><span class="ct-count" id="evc-2"><br></span></div> 
			<div id="ev-3" class="ct-obsEvtBut"><span id="evl-3"></span><span class="ct-count" id="evc-3"><br></span></div> 
			<div id="ev-4" class="ct-obsEvtBut"><span id="evl-4"></span><span class="ct-count" id="evc-4"><br></span></div>
			<div id="ev-5" class="ct-obsEvtBut"><span id="evl-5"></span><span class="ct-count" id="evc-5"><br></span></div> 
			<div id="ev-6" class="ct-obsEvtBut"><span id="evl-6"></span><span class="ct-count" id="evc-6"><br></span></div>
			<div id="ev-7" class="ct-obsEvtBut"><span id="evl-7"></span><span class="ct-count" id="evc-7"><br></span></div><br> 
			<div id="ev-8" class="ct-obsEvtBut"><span id="evl-8"></span><span class="ct-count" id="evc-8"><br></span></div> 
			<div id="ev-9" class="ct-obsEvtBut"><span id="evl-9"></span><span class="ct-count" id="evc-9"><br></span></div> 
			<div id="ev-10" class="ct-obsEvtBut"><span id="evl-10"></span><span class="ct-count" id="evc-10"><br></span></div> 
			<div id="ev-11" class="ct-obsEvtBut"><span id="evl-11"></span><span class="ct-count" id="evc-11"><br></span></div> 
			<div id="ev-12" class="ct-obsEvtBut"><span id="evl-12"></span><span class="ct-count" id="evc-12"><br></span></div> 
			<div id="ev-13" class="ct-obsEvtBut"><span id="evl-13"></span><span class="ct-count" id="evc-13"><br></span></div> 
			<div id="ev-14" class="ct-obsEvtBut"><span id="evl-14"></span><span class="ct-count" id="evc-14"><br></span></div> 
		</div>
		<hr style="margin-bottom:8px;margin-top:2px">
		<table style="margin-top:4px">
			<tr><td class="ct-mediarow"><input id="md-1" type="checkbox"> Diagram/Graph</input></td>
			<td class="ct-mediarow"><input id="md-2" type="checkbox"> Object/Manipulative</input></td>
			<td class="ct-mediarow"><input id="md-3" type="checkbox"> Graphic Organizer</input></td></tr>
			<tr><td><input id="md-4" type="checkbox"> Picture</input></td><td><input id="md-5" type="checkbox"> Movie</input></td>
			<td><input id="md-6" type="checkbox"> Text</input></td></tr>
		</table><hr>
		Teacher: <select select id="whichTeacher" class="ct-is" ><option/><option>General</option><option>Special Ed</option><option>Para/IA</option></select>
		&nbsp;&nbsp;Grouping: &nbsp;<select id="teacherTalk" class="ct-is"><option/><option>Whole group</option><option>Small group</option>
		<option>Individual</option><option>Other adult</option><option>No one</option></select>&nbsp;&nbsp;
		Co-teaching?&nbsp;&nbsp;<select id="teacherModel" class="ct-is"><option/><option>NONE</option><option>Alternative</option>
		<option>1-teach/1-observe</option><option>1-teach/1-assist</option><option>Parallel</option><option>Stations</option><option>Team</option></select>
		<hr>
		Student actions:&nbsp;&nbsp;<select id="studentAction" class="ct-is"><option>Choose</option></select>
		<textarea id="obsNote" class="ct-notes" type="text" placeholder="Type new note here"></textarea>
		<div style="margin-top:8px;font-size:10px;float:right">
			<div id="obsNoteOops" class="ct-notesBut" style="background-color:#e67e22;margin-bottom:3px">Oops</div><br>
			<div id="obsNoteSend" class="ct-notesBut">Send</div>
		</div>
		<hr style="margin-bottom:12px;margin-top:4px">
		<div id="obsDone" class="ct-obsDone">Done</div>
		<span style="float:right;color:#666">Help&nbsp;<a style="float:right" href="https://docs.google.com/document/d/19l87L5sZfLohU6rhQKLMERTNHhQr-jLiE4xQJeYN_3g/edit?usp=sharing" target="_blank">
		<img src="img/helpicon.gif" style="vertical-align:bottom" title="Show help"></a></span><br>
	</div> <!-- ObsPanel --> 

<script>

//////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

var curTime=0;															// Saves time in task
var timingInterval=null,totInterval=null;								// Timing interval
var totTiming=0;														// Time on task timing
var inPlay=false;														// Play flag
var curCat=-1;curPrac=-1;												// Current category, practice
var vocabTopicTerms=[];													// Holds vocab/topic terms
var menus=[];															// Holds menus
var kidsInClass=0;														// Number of kids in class
var dataMedia=[];														// Holds media buttons											
var dataLabs=[];														// Holds OTR button labels											
var dataLabVals=[];														// Holds OTR button values											
var dataLabCats=[];														// Holds OTR button categories											
var dataLabCols=[];														// Holds OTR button colors											
var dataActs=[];														// Holds media buttons											
var dataAcad=[];														// Holds academic diciplines										
			
$(document).ready(function() {								           	// ON PAGE LOADED
	var menu="menus.txt";												// Default menu
	var url=window.location.search.substring(1);						// Get query string
	if (url) {															// If something on command line
		menu=url;														// Get name
		if (!menu.match(/\.txt/))	menu+=".txt";						// Add ext if not there
		}
	$.ajax({ type: "GET", url: menu, success: function(text) {			// Get menus text tile
		var i,j,o,cp,cc,subs;
		text=text.replace(/\n\r/g,"\n");								// LFCR -> LF
		text=text.replace(/\r\n/g,"\n");								// CRLF -> LF
		text=text.replace(/\r/g,"");									// Remove CR
		var lines=text.split("\n");										// Spit by line
		for (i=0;i<lines.length;++i) {									// For each line
			o=lines[i];													// Point at line
			if (!o)	continue;											// Skip blanks
			if (o.match(/:/)) {											// At new category
				cc=menus.length;										// Get index
				menus.push({});											// Add cat obj
				menus[cc].cname=o.substr(0,o.length-1);					// Add cat name
				menus[cc].prac=[];										// Add array for practices									
				}
			else if (o.match(/\*/)) {									// At new * category
				cp=menus[cc].prac.length;								// Get prac index
				menus[cc].prac.push({});								// Add practice obj
				menus[cc].prac[cp].pname=o.split(" *")[0];				// Add prac name
				menus[cc].prac[cp].subs=[];								// Add array for sub-practices									
				subs=o.split("&")[1].split(",");						// Get subs, if any
				for (j=0;j<subs.length;++j)								// For each sub
					if (subs[j].length)									// If something there
						menus[cc].prac[cp].subs.push(subs[j]);			// Add to practice
				}
			else if (o.match(/MEDIA=/i)) 								// Media button
				dataMedia=o.substr(6).split(",");						// Get options
			else if (o.match(/BUTVAL=/i)) 								// OTR button value
				dataLabVals=o.substr(7).split(",");						// Get options
			else if (o.match(/BUTLAB=/i)) 								// OTR button label
				dataLabs=o.substr(7).split(",");						// Get options
			else if (o.match(/BUTCAT=/i)) 								// OTR button category
				dataLabCats=o.substr(7).split(",");						// Get options
			else if (o.match(/BUTCOL=/i)) 								// OTR button color
				dataLabCols=o.substr(7).split(",");						// Get options
			else if (o.match(/STUACT=/i)) 								// Student actions
				dataActs=o.substr(7).split(",");						// Get options
			else if (o.match(/ACAD=/i)) 								// Disciplines
				dataAcad=o.substr(5).split(",");						// Get options
			}
		}});

	$("#splashDiv").animate({ opacity:1 },1000);						// Show logo

	$("#startIt").on("click", function() {								// ON START CLICK
		$("#splashDiv").animate({ opacity:0 },400);						// Hide logo
		$("#obsPanel").animate({ opacity:1}, 1500, function() {			// Show interface
			GetIntroData();												// Get intro data from user
			InitObs();													// Init observation screen
			$("#splashDiv").hide();										// Hide splash
			});
		})

	});																	// End onReady()		

function GetIntroData()												// GET INTRO DATA FROM USER
{
	var str="<table>";
	str+="<tr><td>Teacher&nbsp;ID:</td><td><input class='ct-is' id='intro-id' type='Text'></input></td></tr>";
	str+="<tr><td>Observer&nbsp;name:</td><td><input class='ct-is' id='intro-name' type='Text'></input></td></tr>";
	str+="<tr><td>Observer&nbsp;email:</td><td><input class='ct-is' id='intro-email' type='Text'></input></td></tr>";
	str+="<tr><td>Grade:</td><td><select id='intro-grade' class='ct-is'>";
	str+="<option>K</option><option>1</option><option>2</option><option>3</option><option>4</option>";
	str+="<option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>";
	str+="<option>10</option><option>11</option><option>12</option></select></td></tr>";
	str+="<tr><td>Academic content:</td><td><select id='intro-sub' class='ct-is'><select>";
	str+="<tr><td>Number&nbsp;of&nbsp;students:&nbsp;&nbsp;</td><td><input class='ct-is' id='intro-numkids' type='Text'></input></td></tr>";
	str+="<tr><td>Date:</td><td><input class='ct-is' id='intro-date' type='date'></td></tr>";
	str+="<tr><td>Block/Time:</td><td><input class='ct-is' id='intro-block' type='text'></td></tr>";
	str+="<tr><td>Instructional setting:</td><td><select id='intro-setting' class='ct-is'><option>Self-contained (Academic)</option><option>Self-contained (Severe/Profound)</option>";
	str+="<option>Co-taught</option><option>Inclusive</option><option>General Education only</option></td></tr>";
	str+="<tr><td>Video&nbsp;source:</td><td><input class='ct-is' id='intro-video' placeholder='URL of video, if not live' type='Text'></input></td></tr>";
	str+="<tr><td>Remind&nbsp;every:</td><td><select id='intro-tot' class='ct-is'>";
	str+="<option>0</option><option>.5</option><option>1</option><option>1.5</option><option selected>2</option><option>5</option><option>10</option></select> min(s) students on task</td></tr>";
	str+="</table><br>"
	str+="<div style='float:right'> Help <a href='https://docs.google.com/document/d/19l87L5sZfLohU6rhQKLMERTNHhQr-jLiE4xQJeYN_3g/edit?usp=sharing' target='_blank'>";
	str+="<img src='img/helpicon.gif' style='vertical-align:bottom' title='Show help'></a></div>";
	
	DialogBox("Setup",str, function() {									// Run dialog
		SaveEvent(0,"TeacherID",$("#intro-id").val(),"",0);				// Save events
		SaveEvent(0,"ObserverName",$("#intro-name").val(),"",0);			
		SaveEvent(0,"ObserverEmail",$("#intro-email").val(),"",0);			
		SaveEvent(0,"Grade",$("#intro-grade").val(),"",0);			
		SaveEvent(0,"Subject",$("#intro-sub").val(),"",0);			
		SaveEvent(0,"Date",$("#intro-date").val(),"",0);			
		SaveEvent(0,"Block",$("#intro-block").val(),"",0);			
		SaveEvent(0,"Setting",$("#intro-video").val() ? $("#intro-video").val() : "Live" , $("#intro-setting").val(),0);			
		totTiming=$("#intro-tot").val();

		if ($("#intro-numkids").val()) 								// If num kids set
			kidsInClass=isNaN($("#intro-numkids").val()) ? 0 : $("#intro-numkids").val()-0;	// Set it
		});

	Date.prototype.toDateInputValue = (function() {
    	var local = new Date(this);
    	local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
   		return local.toJSON().slice(0,10);
		});

	$('#intro-date').val(new Date().toDateInputValue());

	for (i=0;i<dataAcad.length;++i)
		$("#intro-sub").append("<option>"+dataAcad[i]+"</option>");

	for (i=0;i<menus.length;++i)
		$("#intro-cat").append("<option>"+menus[i].cname+"</option>");
}

function GetTimeOnTask()											// ASK USER FOR TIME ON TASK
{
	var i;
	$("#alertBoxDiv").remove();											// Remove any old ones
	$("body").append("<div class='qm-unselectable' id='alertBoxDiv'></div>");														
	var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
	str+="<span class='ct-dialogTitle'>What percentage of students are OFF Task?</span><p>";
	str+="<div style='font-size:12px;margin:14px;text-align:center'><br><br>";
	for (i=0;i<110;i+=10) {												// Make 10 categories
		str+="<div id='tot-"+i+"' style='width:200px;background-color:rgb(0,"+(75+Math.floor(i*1.4))+",0);margin-bottom:4px;' class='ct-obsNewPrac'>"+i+" percent";
			if (kidsInClass) 											// If setting kids
				str+="&nbsp&nbsp;-&nbsp&nbsp;"+Math.round(i/100*kidsInClass)+" students";
		str+="</div><br>";
		}
	str+="<br><div id='tot-999' style='width:120px;background-color:#e67e22;margin-bottom:4px;' class='ct-obsNewPrac'>Skip</div>"
	str+="</div>";
	$("#alertBoxDiv").append(str);	
	$("#alertBoxDiv").dialog({ 	 width:$("#obsPanel").width()+16, height:$("#obsPanel").height()+24 });	
	$("#alertBoxDiv").dialog("option","position",{ my:"middle", at:"middle", of:obsPanel });
	
	$("[id^=tot-]").on("click", function(e) {							// ON PERCENTAGE PICK	
		var id=e.currentTarget.id.substr(4);							// Get id			
		if (id != 999)													// If not skipping
			SaveEvent(curTime,"Student status","Percent engaged",100-id,0);	// Save event
		$("#alertBoxDiv").remove();  									// Close it
		});
}

function InitObs() 													// INIT OBSERVATION PANEL
{
	var i;
	for (i=1;i<=dataMedia.length;++i) {									// For each media
		$("#md-"+i).on("click", function(e) {							// On box click
			var act=$(this).prop("checked") ? "active" : "inactive";	// Active
			var id=e.currentTarget.id.substr(3)-1;						// Get id			
			SaveEvent(curTime,"Visual Aid",dataMedia[id],act,0);		// Save event
			});
		}
	for (i=0;i<dataActs.length;++i) 									// For each student action
		$("#studentAction").append("<option>"+dataActs[i]+"</option>");	// Add option

	for (i=1;i<=dataLabs.length;++i) {									// For each event button
		$("#evl-"+i).html(dataLabs[i-1]+"<br>");						// Set label
		$("#ev-"+i).css("background-color",dataLabCols[i-1]);			// Set back color

		$("#ev-"+i).on("click", function(e) {							// On event button click
			var id=e.currentTarget.id.substr(3);						// Get id			
			var c=1;													// First one												
			var s=$("#evc-"+id).text();									// Get count from label
			if (s)	c=s.substr(1,s.length-2)-0+1						// If not first, get and increment
			$("#evc-"+id).html("("+c+")");								// Show new count
			Sound("click");												// Click sound	
			SaveEvent(curTime,dataLabCats[id-1],dataLabVals[id-1],"",0);// Save event
			});

		$("#evc-"+i).on("click", function(e) {							// ON EVENT CLICK
			e.stopPropagation();										// Stop propagation
			var id=e.currentTarget.id.substr(4);						// Get id			
			var s=$("#evc-"+id).text();									// Get count from label
			var c=s.substr(1,s.length-2)-1								// If not first, get and decrement
			if (c)														// Something to show
				$("#evc-"+id).html("("+c+")");							// Show new count
			else														// No counts
				$("#evc-"+id).html("<br>");								// Clear display
			Sound("delete");											// Delete sound	
			SaveEvent(curTime,dataLabCats[id-1],dataLabVals[id-1],"NEGATE",0);	// Save event
			});
		}

	$("#obsStart").on("click", function(e) {							// START/STOP TIMER
		inPlay=!inPlay;													// Toggle state
		SetPlayMode(inPlay);											// Set play mode
		});
	
	$("#obsNoteSend").on("click", function(e) {							// ON NOTE SEND
		if (!$("#obsNote").val())										// If no value
			return;														// Quit
		SaveEvent(curTime,"Note",$("#obsNote").val(),"",0);				// Save event
		$("#obsNote").val("");											// Clear textarea
		Sound("click");													// Click sound	
		});

	$("#obsNoteOops").on("click", function(e) {							// ON OOPS SEND
		if (!$("#obsNote").val())										// If no value
			return;														// Quit
		SaveEvent(curTime,"Note","!!!! OOPS !!!!! ---- "+$("#obsNote").val(),"",0);	// Save event
		$("#obsNote").val("");											// Clear textarea
		Sound("click");													// Click sound	
		});

	$("#obsNewCat").on("click", function(e) {							// ON CHANGE CATEGORY
		var i;
		$("#alertBoxDiv").remove();										// Remove any old ones
		$("body").append("<div class='qm-unselectable' id='alertBoxDiv'></div>");														
		var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span class='ct-dialogTitle'>Choose a category</span><p>";
		str+="<div style='font-size:12px;margin:14px'>";
		str+="<div id='pracList' class='ct-obsPracList'>";				// List holder
		for (i=0;i<menus.length;++i)									// For each category
			str+="<div id='cat-"+i+"'class='ct-obsPracItem'>"+menus[i].cname+"</div>";	// Add title
			str+="</div>";
		$("#alertBoxDiv").append(str);	
		$("#alertBoxDiv").dialog({ 	 width:$("#obsPanel").width()+16, height:$("#obsPanel").height()+24 });	
		$("#alertBoxDiv").dialog("option","position",{ my:"middle", at:"middle", of:obsPanel });
		
		$("[id^=cat-]").on("click", function(e) {						// ON CATEGORY CHOOSE		
			curCat=e.currentTarget.id.substr(4);						// Get id			
			$("#obsCat").text(menus[curCat].cname);						// Show new name
			$("#alertBoxDiv").remove();  								// Close it
			$("#obsPracText").html("");									// Remove practices
			curPrac=-1;													// No practuce index
			Sound("click");												// Click sound	
			});
		});

	$("#obsNewPrac").on("click", function(e) {							// ADD NEW PRACTICE
		var i;
		if (curCat < 0)													// Not category yet											
			return;														// Quit
		$("#alertBoxDiv").remove();										// Remove any old ones			
		if (curPrac != -1)												// If not first one
			SaveEvent(curTime,"Teacher actions",menus[curCat].cname,menus[curCat].prac[curPrac].pname+"->OFF",0);	// Save event
		
		$("body").append("<div class='qm-unselectable' id='alertBoxDiv'></div>");														
		var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span class='ct-dialogTitle'>Choose a practice</span><p>";
		str+="<div style='font-size:12px;margin:14px'>";
		str+="<div id='pracList' class='ct-obsPracList'>";				// List holder
		for (i=0;i<menus[curCat].prac.length;++i)	{					// For each practice
			var title=menus[curCat].prac[i].pname;						// Extract title
			str+="<div id='opl-"+i+"'class='ct-obsPracItem'>"+title+"</div>";	// Add title
			}
		$("#alertBoxDiv").append(str);	
		$("#alertBoxDiv").dialog({ 	 width:$("#obsPanel").width()+16, height:$("#obsPanel").height()+24 });	
		$("#alertBoxDiv").dialog("option","position",{ my:"middle", at:"middle", of:obsPanel });
		
		$("[id^=opl-]").on("click", function(e) {						// On choosing one		
			var str="";			
			var id=e.currentTarget.id.substr(4);						// Get id			
			curPrac=id;													// Set current practice
			str+="<div style='display:inline-block;margin-bottom:4px;margin-top:4px'>"+menus[curCat].prac[curPrac].pname+"</div><br>";
			for (i=0;i<menus[curCat].prac[id].subs.length;++i) {
				str+="<div id='"+menus[curCat].prac[id].pname+"->"+menus[curCat].prac[id].subs[i];
				str+="' class='ct-obsPracSubs'>&bull;&nbsp;"+menus[curCat].prac[id].subs[i]+"</div>";
				}
		str+="<div id='"+menus[curCat].prac[id].pname+"->' class='ct-obsPracSubs'>&bull;&nbsp;This practice</div>";
		str+="<br>";
		$("#obsPracText").html(str);
		
		$(".ct-obsPracSubs").on("click", function(e) {					// CLICK ON PRACTICE SUB
				var id=e.currentTarget.id;								// Get id			
				if ($(this).css("font-weight") == "bold")				// Already set
					return;												// Quit
				$(this).css({ color:"#009900","font-weight":"bold"});	// Highlight it
				SaveEvent(curTime,"Teacher actions",menus[curCat].cname,id,0);	// Save event
				Sound("click");											// Click sound	
			});

			$("#alertBoxDiv").remove();  								// Close it
			Sound("click");												// Click sound	
			});
		});

	$("#studentAction").on("change", function(e) {						// STUDENT ACTION
		SaveEvent(curTime,"Student actions","Action",$(this).val(),0);	// Send event
		Sound("click");													// Click sound	
		});													

	$("#teacherTalk").on("change", function(e) {						// ON WHICH TALKING
		SaveEvent(curTime,"Teacher status","Grouping",$(this).val(),0);	// Send event		
		Sound("click");													// Click sound	
		});													

	$("#whichTeacher").on("change", function(e) {						// ON WHICH TEACHER
		SaveEvent(curTime,"Teacher status","Which Teacher",$(this).val(),0); 	// Send event		
		Sound("click");													// Click sound	
		});													

	$("#teacherModel").on("change", function(e) {						// ON TEACHER MODEL
		SaveEvent(curTime,"Teacher status","Model",$(this).val(),0); 	// Send event		
		Sound("click");													// Click sound	
		});													

	$("#newTerm").on("keypress", function(e) {							// ENTER HIT FOR NEW TERM
		if (e.which == 13)												// Enter key hit
			$("#sendTerm").trigger("click");							// Simulate save click
		});													
	
	$("#sendTerm").on("click", function(e) {							// ON SAVE TERM														
		if (!$("#newTerm").val())										// Nothing there						
			return;														// Quit
		Sound("click");													// Click sound	
		SaveEvent(curTime,"Vocab word",$("#newTerm").val(),"Started",0);// Save term
		vocabTopicTerms.push($("#newTerm").val());						// Add to list
		$("#newTerm").val("");											// Clear
		fillTermList();													// Fill term list
		});

		function fillTermList() {										// FILL TERM LIST									
			var i;
			var str="Currently active terms <i>(click to remove): </i>";// Header			
			for (i=0;i<vocabTopicTerms.length;++i) 	{					// For each term
				if (i)	str+=", ";										// Add separator
				str+="<span id='termItem-"+i+"' style='cursor:zoom-out;color:#009900'><b>"+vocabTopicTerms[i]+"</b></span>";	// Add term
				}
			$("#vocabTerms").html(str);									// Show all terms
			
			$("[id^=termItem-]").on("click", function(e) {				// On click of item		
				var id=e.currentTarget.id.substr(9);					// Get id			
				SaveEvent(curTime,"Vocab word",$("#termItem-"+id).text(),"Stopped",0);	// Stop term
				vocabTopicTerms.splice(id,1);							// Remove it
				Sound("delete");										// Delete sound	
				fillTermList();											// Fill term list
				});
			}
	}

	function SetPlayMode(mode) {
		if (inPlay)	{
			$("#obsStart").prop("src","img/pausebut.png");				// Pause but		
			Sound("click");												// Click sound	
			SetTimer("start");											// Start timer
			}
		else{		
			$("#obsStart").prop("src","img/playbut.png");				// Play but		
			Sound("delete");											// Delete sound	
			SetTimer("pause");											// Stop timer
			}
		}

	function SetTimer(mode) {
		clearInterval(timingInterval);									// Clear timer
		clearInterval(totInterval);										// Clear tot timer

		if ((totTiming > 0) && inPlay)									// If tot time set and playing
			totInterval=setInterval( function() {						// Start tot timer
					GetTimeOnTask();									// Payload
					},totTiming*60000);									// Set time

		inPlay=false;													// Not in play
		if (mode == "start") {											// Timing
			inPlay=true;												// In play
			timingInterval=setInterval(function() {						// Start timer
				showTime(++curTime);									// Add to count and show
				} ,1000);												// 1fps
			}
		else if (mode == "reset")										// Reset
			curTime=0;													// To 0
	
		function showTime(time) {										// DISPLAY CURRENT TIME
			var secs=time%60;											// Get secs
			if (secs == 0)		secs="00";								// Double 0
			else if (secs < 10) secs="0"+secs;							// Add leading 0
			var mins=Math.floor(time/60);								// Get mins
			if (mins == 0)		mins="00";								// Double 0
			else if (mins < 10) mins="0"+mins;							// Add leading 0
			$("#obsTimerText").text(mins+":"+secs);						// Set display
			}
	}

	function SaveEvent(time, p1, p2, p3, p4)
	{
		trace(time+","+p1+","+p2+","+p3+","+p4);
	}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function DialogBox(title, content, callback, callback2) 	// DIALOG BOX
	{
		$("#dialogDiv").remove();												
		$("body").append("<div class='unselectable' id='dialogDiv'></div>");														
		var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span class='ct-dialogTitle'>"+title+"</span><p>";
		str+="<div style='font-size:12px;margin:14px'>"+content+"</div>";
		$("#dialogDiv").append(str);	
		$("#dialogDiv").dialog({ width:$("#obsPanel").width()+16, height:$("#obsPanel").height()+24, 
								 buttons: {
					            	"OK": 		function() { if (callback)
					            								callback(); 
					            								$("#dialogDiv").animate({ opacity:0},200, function() {	
																	$("#dialogDiv").remove();  
																	});
					            								},
					            	"Cancel":  	function() { if (callback2)	            		
					            								callback2();
				            									$("#dialogDiv").animate({ opacity:0},200, function() {		
																	$("#dialogDiv").remove();  
																	});
																}
									}});	
		$("#dialogDiv").dialog("option","position",{ my:"left top", at:"left top", of:obsPanel });
	}

	function GetTextBox(title, content, def, callback)					// GET TEXT LINE BOX
	{
		$("#alertBoxDiv").remove();											// Remove any old ones
		$("body").append("<div class='qm-unselectable' id='alertBoxDiv'></div>");														
		var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span class='ct-dialogTitle'>"+title+"</span><p>";
		str+="<div style='font-size:12px;margin:14px'>"+content+"</div>";
		str+="<p><input class='qm-is' type='text' id='gtBoxTt' value='"+def+"'></p></div>";
		$("#alertBoxDiv").append(str);	
		$("#alertBoxDiv").dialog({ width:300, buttons: {
					            	"OK": 		function() { callback($("#gtBoxTt").val()); $(this).remove(); },
					            	"Cancel":  	function() { $(this).remove(); }
									}});	
		}

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function ShortenString(str, len)									// SHORTEN A STRING TO LENGTH
	{
		if (str && str.length > len)										// Too long
			str=str.substr(0,(len-3)/2)+"..."+str.slice((len-3)/-2);		// Shorten	
		return str;															// Return string
	}

	function Sound(sound, mute)												// PLAY SOUND
	{
		var snd=new Audio();													// Init audio object
		if (!snd.canPlayType("audio/mpeg") || (snd.canPlayType("audio/mpeg") == "maybe")) 
			snd=new Audio("img/"+sound+".ogg");									// Use ogg
		else	
			snd=new Audio("img/"+sound+".mp3");									// Use mp3
		if (!mute)	{															// If not initing or muting	
			snd.volume=50/100;													// Set volume
			snd.play();															// Play it
			}
		}

	function SetCookie(cname, cvalue, exdays)								// SET COOKIE
	{
		var d=new Date();
		d.setTime(d.getTime()+(exdays*24*60*60*1000));
		var expires = "expires="+d.toGMTString();
		document.cookie = cname + "=" + cvalue + "; " + expires;
	}
	
	function GetCookie(cname) 												// GET COOKIE
	{
		var name=cname+"=",c;
		var ca=document.cookie.split(';');
		for (var i=0;i<ca.length;i++)  {
		  c=ca[i].trim();
		  if (c.indexOf(name) == 0) 
		  	return c.substring(name.length,c.length);
		  }
		return "";
	}
		
</script>
</body>
</html>
