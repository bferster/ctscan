<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="css/jquery-ui.min.css"></link>
	<script src="lib/jquery.min.js"></script>
	<script src="lib/jquery-ui.min.js"></script>
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>CTScan Data view</title>

	<style type="text/css">
		 
		 body { 			font-family: Verdana,Geneva,sans-serif; font-size:13px; box-sizing: border-box;
							padding: 0px; margin: 0px; 
							}
		.ct-viewPanel {		background-color:#ddd; border-radius: 6px; margin-top: 24px; padding: 12px; max-width: 780px;
							margin-left: auto; margin-right: auto;
							}
		.ct-dataPanel {		border-radius: 6px; background-color:#eee;padding: 12px; max-width: 780px; margin-left: auto; margin-right: auto; max-height:800px;
							overflow-x:hidden; overflow-y:auto;
							}
		.ct-is 	{			border-radius:4px; padding-left:8px; border: 1px solid #999; margin-bottom: 3px;
							}

		.ct-dialogTitle {	font-size: 20px; font-weight: bold; color: #000; margin-bottom: 8px; user-select: none;
							}
		.ct-actionBut {		cursor: pointer; color:#fff; 
							text-align: center; border-radius: 6px; display: inline-block; user-select: none;
							font-size: 12px; background-color: #27ae60; padding: 2px 8px 2px 8px; vertical-align:-3px;
							}
		.ui-dialog-buttonpane.ui-widget-content.ui-helper-clearfix { border:none }
		.ui-dialog { border-radius:6px; background-color:#ddd }
		.ui-button { border-radius:30px;outline:none }
		.ui-dialog-titlebar { display:none }
		 table {			border-spacing: 0px;  }
		 input {		    vertical-align: -2px; }

</style>
</head>
<body>
	<br>
	<div style="margin-left: auto; margin-right: auto;text-align:center;width500px;" >
		<img src="img/ctlogo400.png" width="150"><br><br>
		<b>Classroom Teaching Scan Data Viewer</b><br>
	</div>
	<div id="viewPanel" class="ct-viewPanel">
		<div style="width:100%;max-height:75%;overflow-y:auto"">
			<table id="sessionTable" tyle="width:100%;>	
				<tr style="font-weight:bold"><td>&nbsp;&#x2610;&nbsp;&nbsp;</td><td>Observer</td><td>Email</td><td>Date</td><td>Teacher</td><tr><tr>
					<tr><td colspan='6'><hr></td></tr>
					<td><input type="checkbox" id="chooseAll"/></td>
					<td><input id="viewObs" class="ct-is"/></td>
					<td><input id="viewEmail" class="ct-is"/></td>
					<td nowrap><select id="viewDateComp" class="ct-is" style="height:19px;vertical-align:-2px;margin-right:-3px;"><option></option><option selected>=</option><option>!=</option><option><</option><option><=</option><option>></option><option>>=</option></select>
					<input id="viewDate" class="ct-is"style="height:17px" type="date"/></td>
					<td><input id="viewTid" class="ct-is"/></td></tr>
					<tr><td colspan='6'><hr></td></tr>
			</table>
			<hr>
			<div id="showRaw" class="ct-actionBut">View raw data</div>&nbsp;&nbsp;
			<div id="showCSV" class="ct-actionBut">View CSV data</div>&nbsp;&nbsp;
			<div id="showTimeline" class="ct-actionBut">View timeline</div>&nbsp;&nbsp;
			<div id="showReport" class="ct-actionBut">View Report</div>
			<input style="float:right" id="password" type="password" class="ct-is" placeholder="Type password here"/>
		</div>	
 	</div><br>
	<div id="dataPanel" class="ct-dataPanel">No sessions selected...</div>

<script>

//////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

var curJson=null;															// Holds session results

$(document).ready(function() {								           	// ON PAGE LOADED

	Date.prototype.toDateInputValue = (function() {							// Set today's date
			var local=new Date(this);										// Get UTC
			return local.toJSON().slice(0,10);								// Get date portion
			});
	$("#viewDate").val(new Date().toDateInputValue());						// Init date to today
	SetHandlers();															// Set up handlers
	GetObservations();														// Show matching observations
	});		

	function SetHandlers() 												// SET EVENT HANDLERS							
	{
		$("#viewObs").on("change", function(e) {							// ON OBS CHANGE
			GetObservations("obs");											// Show matching observations
			});													
		$("#viewDate").on("change", function(e) {							// ON DATE CHANGE
			GetObservations("date");										// Show matching observations
			});													
		$("#viewDateComp").on("change", function(e) {						// ON DATE COMPARATOR CHANGE
			GetObservations("date");										// Show matching observations
			});													
		$("#viewEmail").on("change", function(e) {							// ON EMAIL CHANGE
			GetObservations("email");										// Show matching observations
			});													
		$("#viewTid").on("change", function(e) {							// ON OBS CHANGE
			GetObservations("tid");											// Show matching observations
			});													
		$("#chooseAll").on("click", function(e) {							// ON CHECK ALL
			$("input:checkbox").prop("checked",$(this).prop("checked"));	// Toggle
			});													
		$("#showRaw").on("click", function(e) {								// ON SHOW RAW
			var i;
			$("#dataPanel").html("No sessions selected...");				// Clear data panel										
			for (i=0;i<curJson.length;++i) {								// For each session
				if ($("#sessId-"+i).prop("checked")) { 						// If checked
					$("#dataPanel").html("");								// Clear data panel	
					break;
					}	
				}								
			for (i=0;i<curJson.length;++i) {								// For each session
				if ($("#sessId-"+i).prop("checked")) 						// If checked
					ShowRawData(i);											// Show raw data
				}	
			});													
	
	}

	function ShowRawData(num)											// SHOW RAW DATA
	{
		var i
		var str="<table>"
		str+="<tr><td><b>Observer:</b></td><td>"+curJson[num].obs+"<td></tr>";
		str+="<tr><td><b>Observer email:&nbsp;&nbsp;</b></td><td>"+curJson[num].email+"<td></tr>";
		str+="<tr><td><b>Teacher Id:</b></td><td>"+curJson[num].teacherId+"<td></tr>";
		str+="<tr><td><b>Grade:</b></td><td>"+curJson[num].grade+"<td></tr>";
		str+="<tr><td><b>Subject:</b></td><td>"+curJson[num].subject+"<td></tr>";
		str+="<tr><td><b>Date:</b></td><td>"+curJson[num].date+"<td></tr>";
		str+="<tr><td><b>Block:</b></td><td>"+curJson[num].block+"<td></tr>";
		str+="<tr><td><b>Setting:</b></td><td>"+curJson[num].setting+"<td></tr>";
		str+="<tr><td><b>Video:</b></td><td>"+curJson[num].video+"<td></tr>";
		str+="<tr><td><b>Reminder:</b></td><td>"+curJson[num].remind+"<td></tr>";
		str+"<br>";
		var d=$.parseJSON(curJson[num].events);
		for (i=0;i<d.length;++i){
			str+="<tr><td><b>Event:</b></td><td><div style='display:inline-block;width:50px;'>"+d[i].time+"</div>";
			str+=d[i].d1+", "+d[i].d2;+", "+d[i].d3+"</td></tr>";
			}	
		str+="</table><hr>";
		$("#dataPanel").append(str);										// Add to data panel										
	}

	function GetObservations()											// GET SELECTED OBSERVATIONS FROM DB
	{
		var obs=$("#viewObs").val();										// Get observer name
		var email=$("#viewEmail").val();									// Get observer email
		var now=$("#viewDate").val();										// Get date
		var tid=$("#viewTid").val();										// Get teacher id
		var dc=$("#viewDateComp").val();									// Get date comparator
	
		var q="id != '0'";													// Query base (all)
	
		if (dc)																// If a date set
			q+=" AND date "+dc+"'"+now+"'";									// Add date to query				
		if (obs)															// If an obs set
			q+=" AND obs LIKE '%"+obs+"%'";									// Add to query				
		if (email)															// If an set
			q+=" AND email LIKE '%"+email+"%'";								// Add to query				
		if (tid)															// If a tis set
			q+=" AND teacherId LIKE '%"+tid+"%'";							// Add to query				
	
		q+=" ORDER BY date DESC";											// Sort by
	 	$("#sessionTable").find("tr:gt(5)").remove();						// Clear sessions

		Query(q, function(d) { 												// Send query
			var i,str;
			if (!d || d == "null")	{										// No hits													
				$("#sessionTable").append("<tr><td colspan='5'>No sessions matched...</td></tr>");	// Tell			
				return;;													// Quit
				}
			d=$.parseJSON(d);												// Objectify result
			curJson=d;														// Save data
			for (i=0;i<d.length;++i) {										// For each one
				str="<td><input type='checkbox' id='sessId-"+i+"'/></td>";	// Checkbox
				str+="<td>"+d[i].obs+"</td>";								// Fill obs
				str+="<td>"+d[i].email+"</td>";								// Fill email
				str+="<td>"+d[i].date+"</td>";								// Fill date
				str+="<td>"+d[i].teacherId+"</td>";							// Fill tid
				$("#sessionTable").append("<tr>"+str+"</tr>");
				}
			});
	
	Sound("click");															// Click sound	
	}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function Query(query, callback) 
	{
		var dat={ q:query.replace(/'/g,"~") };
		var url="//classroomteachingscan.com/ctscan/query.php";				// Target

		$.ajax({ url:url,dataType:'text',type:"GET",crossDomain:true,data:dat,  // Get data
			success:function(d) { callback(d) },							// Run callback				
			error:function(xhr,status,error) { trace(error) },				// Show error
			});		
	}
		
	function DialogBox(title, content, callback, callback2) 	// DIALOG BOX
	{
		$("#dialogDiv").remove();												
		$("body").append("<div class='unselectable' id='dialogDiv'></div>");														
		var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span class='ct-dialogTitle'>"+title+"</span><p>";
		str+="<div style='font-size:12px;margin:14px'>"+content+"</div>";
		$("#dialogDiv").append(str);	
		$("#dialogDiv").dialog({ width:$("#obsPanel").width()+16, height:$("#obsPanel").height()+24, 
								 buttons: {
					            	"OK": 		function() { if (callback)
					            								callback(); 
					            								$("#dialogDiv").animate({ opacity:0},200, function() {	
																	$("#dialogDiv").remove();  
																	});
					            								},
					            	"Cancel":  	function() { if (callback2)	            		
					            								callback2();
				            									$("#dialogDiv").animate({ opacity:0},200, function() {		
																	$("#dialogDiv").remove();  
																	});
																}
									}});	
		$("#dialogDiv").dialog("option","position",{ my:"left top", at:"left top", of:obsPanel });
	}

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function ShortenString(str, len)									// SHORTEN A STRING TO LENGTH
	{
		if (str && str.length > len)										// Too long
			str=str.substr(0,(len-3)/2)+"..."+str.slice((len-3)/-2);		// Shorten	
		return str;															// Return string
	}

	function Sound(sound, mute)												// PLAY SOUND
	{
		var snd=new Audio();													// Init audio object
		if (!snd.canPlayType("audio/mpeg") || (snd.canPlayType("audio/mpeg") == "maybe")) 
			snd=new Audio("img/"+sound+".ogg");									// Use ogg
		else	
			snd=new Audio("img/"+sound+".mp3");									// Use mp3
		if (!mute)	{															// If not initing or muting	
			snd.volume=50/100;													// Set volume
			snd.play();															// Play it
			}
		}

	function SetCookie(cname, cvalue, exdays)								// SET COOKIE
	{
		var d=new Date();
		d.setTime(d.getTime()+(exdays*24*60*60*1000));
		var expires = "expires="+d.toGMTString();
		document.cookie = cname + "=" + cvalue + "; " + expires;
	}
	
	function GetCookie(cname) 												// GET COOKIE
	{
		var name=cname+"=",c;
		var ca=document.cookie.split(';');
		for (var i=0;i<ca.length;i++)  {
		  c=ca[i].trim();
		  if (c.indexOf(name) == 0) 
		  	return c.substring(name.length,c.length);
		  }
		return "";
	}
		
</script>
</body>
</html>
