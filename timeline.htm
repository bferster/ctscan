<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="css/jquery-ui.min.css"></link>
	<script src="lib/jquery.min.js"></script>
	<script src="lib/jquery-ui.min.js"></script>
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>CTScan Timeline</title>

	<style type="text/css">
		 
		 body { 			font-family: Verdana,Geneva,sans-serif; font-size:13px; box-sizing: border-box;
							padding: 0px; margin: 0px; 
							}
		.ct-mainPanel {		background-color:#eee; border-radius: 6px; margin-top: 16px; padding: 12px; max-width: 1200px;
							margin-left: auto; margin-right: auto; opacity: 0;
							}
		.ct-dataPanel {		margin-top: 16px; max-width:1200px; margin-left: auto; margin-right: auto; opacity: 0;
							}
		.ct-timePanel {		border-radius: 6px; background-color:#fff; padding: 12px; overflow-x:auto; margin-left:120px;
							}
		.ct-is 	{			border-radius:4px; padding-left:8px; border: 1px solid #999; margin-bottom: 3px;
							}

		.ct-but {			cursor: pointer; color:#fff; 
							text-align: center; border-radius: 6px; display: inline-block; user-select: none;
							font-size: 12px; background-color: #27ae60; padding: 2px 8px 2px 8px; vertical-align:3px;
							}
		.ct-dialogTitle {	font-size: 20px; font-weight: bold; color: #000; margin-bottom: 8px; user-select: none;
							}
		.ct-actionBut {		cursor: pointer; color:#fff; 
							text-align: center; border-radius: 6px; display: inline-block; user-select: none;
							font-size: 12px; background-color: #27ae60; padding: 2px 8px 2px 8px; vertical-align:-3px;
							}
		.ui-dialog-buttonpane.ui-widget-content.ui-helper-clearfix { border:none }
		.ui-dialog { border-radius:6px; background-color:#eee }
		.ui-button { border-radius:30px;outline:none }
		.ui-dialog-titlebar { display:none }
		 table {			border-spacing: 0px;  }
		 input {		    vertical-align: -2px; }

</style>
</head>
<body>
	<div id="mainPanel" class="ct-mainPanel">
	<div style="text-align:center">
		<div style="float:right;line-height:13px">
			<img id="scaleUp"   style="cursor:zoom-in" src="img/upbut.gif"><br>
			<span id="scaleAmt">5</span><br>
			<img id="scaleDown" style="cursor:zoom-out" src="img/downbut.gif"><br>
		</div>
		<img src="img/ctlogo32.png"><br>
		<b>Classroom Teaching Scan Timeline</b></div><br>
			<div style="text-align:right;font-size:12px;width:150px;float:left;margin-top:8px;padding-right:10px;line-height:20px;font-weight:bold">
			<span style="color:#999;font-size:10px">100%</span><br>
			<span style="color:#666;line-height:40px">Engagement</span><br>
			<span style="color:#999;font-size:10px">0%</span><br><br>
			<span style="color:#27ae60" id="med-0">Diagram/Graphic</span><br>
			<span style="color:#27ae60" id="med-1">Object/Manipulative</span><br>
			<span style="color:#27ae60" id="med-2">Graphic Organizer</span><br>
			<span style="color:#27ae60" id="med-3">Picture</span><br>
			<span style="color:#27ae60" id="med-4">Movie</span><br>
			<span style="color:#27ae60" id="med-5">Text</span><br><br>
			<span style="color:#e67e22" id="evt-0">OTR</span><br>
			<span style="color:#e67e22" id="evt-1">Feedback</span><br>
			<span style="color:#e67e22" id="evt-2">Questions</span><br>
			<span style="color:#e67e22" id="evt-3">Custom</span><br><br><br>
			<span style="color:#3db1ff">Vocab</span><br><br><br>
			<span style="color:#888">Student Actions</span><br>
			<span style="color:#e74c3c;line-height:60px">Practice</span><br>
			</div>
		<div id="timePanel" class="ct-timePanel">
		<svg id="svg" width="100%" height="99%"></svg>
		</div>
	</div>
	<div id="dataPanel" class="ct-dataPanel"></div>

<script>

//////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

var curJson=null;															// Holds session results
var obsEvents=null;															// Points at events
var maxTime=0;																// Size of timeline
var svgNS="http://www.w3.org/2000/svg";										// Name space
var scaleSpan=128;															// Scaling
var dataMedia=[];															// Holds media buttons											
var dataLabVals=[];															// Holds OTR button values											
var dataLabCats=[];															// Holds OTR button categories											
var dataActs=[];															// Holds media buttons											
var dataAcad=[];															// Holds academic diciplines

$(document).ready(function() {								           	// ON PAGE LOADED

	var url=window.location.search.substring(1);							// Get query string
	if (!url)	url=15;
	
	document.title+=" ("+url+")";											// Add id to title		
	Query("id = '"+url+"'", function(d) { 									// Send query
		if (!d || d == "null")												// No hits													
			return;;														// Quit
		d=$.parseJSON(d);													// Objectify result
		curJson=d[0];														// Save data
		obsEvents=$.parseJSON(curJson.events);
		for (i=0;i<obsEvents.length;++i) {									// For each event
			if (obsEvents[i].time > maxTime)								// If a longer time
				maxTime=obsEvents[i].time;									// Use it
			}
		Draw();
		ShowData();
		$("#mainPanel").animate({ opacity:1 },1500);						// Show timeline
		$("#dataPanel").animate({ opacity:1 },1500);						// Show data
		});
	$("#scaleDown").on("click", function(e) {								// SCALE DOWN
		if (scaleSpan < 16)													// At max
			return;															// Quit
		$("#scaleAmt").text($("#scaleAmt").text()-1);						// Show scale
		scaleSpan/=2;														// Show less
		Sound("click");														// Click sound
		Draw()
		});

	$("#scaleUp").on("click", function(e) {									// SCALE UP
		if (scaleSpan > 1024)												// At max
			return;															// Quit
		$("#scaleAmt").text($("#scaleAmt").text()-0+1);						// Show scale
		scaleSpan*=2;														// Show less
		Sound("click");														// Click sound
		Draw()
		});
	
	$.ajax({ type: "GET", url: "menus.txt", success: function(text) {	// Get menus text tile
		var i,j,o,cp,cc,subs;
		text=text.replace(/\n\r/g,"\n");									// LFCR -> LF
		text=text.replace(/\r\n/g,"\n");									// CRLF -> LF
		text=text.replace(/\r/g,"");										// Remove CR
		var lines=text.split("\n");											// Spit by line
		for (i=0;i<lines.length;++i) {										// For each line
			o=lines[i];														// Point at line
			if (!o)	continue;												// Skip blanks
			if (o.match(/MEDIA=/i)) 										// Media button
				dataMedia=o.substr(6).split(",");							// Get options
			else if (o.match(/BUTVAL=/i)) 									// OTR button value
				dataLabVals=o.substr(7).split(",");							// Get options
			else if (o.match(/BUTLAB=/i)) 									// OTR button label
				dataLabs=o.substr(7).split(",");							// Get options
			else if (o.match(/BUTCAT=/i)) 									// OTR button category
				dataLabCats=o.substr(7).split(",");							// Get options
			else if (o.match(/STUACT=/i)) 									// Student actions
				dataActs=o.substr(7).split(",");							// Get options
			else if (o.match(/ACAD=/i)) 									// Disciplines
				dataAcad=o.substr(5).split(",");							// Get options
			}
		for (i=0;i<dataMedia.length;++i)									// For each media
			$("#med-"+i).html(dataMedia[i]);								// Set label

		var v=[dataLabCats[0]];
		for (i=1;i<dataLabCats.length;++i)									// For each event category
			if (dataLabCats[i] != v[v.length-1]) 							// Get a unique one
				v.push(dataLabCats[i])										// Add to array
		dataLabCats=v;														// Copy array
		for (i=0;i<dataLabCats.length;++i)									// For each event category
			$("#evt-"+i).html(dataLabCats[i]);								// Set label
	
	}});

});		


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// DRAW
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function Draw()														// DRAW TIMELINE
	{
		var vpos=0;
		var x=8,y;
		var h=530;															
		var i,j,o,p,xs,ys,start,end;
		var mins=Math.ceil(maxTime/60);										// Number of minutes to show
		$("#timePanel").height(h);											// Set panel height
		var w=(mins*scaleSpan)+8;											// Width of timeline
		$("#svg").empty();													// Remove all segs
		document.getElementById('svg').setAttribute("width", (w+scaleSpan)+"px");	// Set SVG width	
		if (w > $("#timePanel").width())									// If no scroller
			h-=18;															// Reduce height
		for (i=0;i<5;++i) {													// For each engagement line
			y=i*16+5;														// Set height
			DrawLine([x,w],[y,y],"#ccc",.5);								// Draw it
			}
		ys=[5, h-23 ];														// Line ys
		DrawLine([x,w],[225,225],"#ccc",.5);								// Draw separators
		DrawLine([x,w],[325,325],"#ccc",.5);
		DrawLine([x,w],[410,410],"#ccc",.5);
		DrawLine([x,w],[440,440],"#ccc",.5);
		DrawLine([x,w],[490,490],"#ccc",.5);
		for (i=0;i<=mins;++i) {												// For each minute
			xs=[x,x];														// Xs
			DrawLine(xs,ys,"#ccc",.5);										// Draw minute tic
			DrawText(x,h-6,"#666",12,i,"middle");							// Label it
			x+=scaleSpan;													// Next pos
			}
		xs=[];	ys=[];														// Engagement line arrays
		o=obsEvents;														// Point at events
		for (i=0;i<o.length;++i) {											// For each event
			start=GetPixFromTime(o[i].time);								// Convert start to pixels
			end=GetPixFromTime(o[i].time+o[i].d5);							// End
			x=start+(end-start)/2;											// Center
			if (o[i].d2 == "Percent engaged") {								// Engagement	
				xs.push(GetPixFromTime(o[i].time));							// X pos
				ys.push((100-o[i].d3)/100*64+5);							// Y pos
				}
			else if (o[i].d1 == "Vocab Word") {								// Vocab	
				y=(vpos*19)+330;											// Position 									
				DrawBox(start,y,end,y+15,"#3db1ff","",0,8);					// Draw bar
				DrawText(x,y+11,"#fff",12,o[i].d2,"middle");				// Draw word
				vpos=(vpos+1)%4;											// Next pos
				}
			else if (o[i].d1 == "Practice") {								// Practice	
				DrawBox(start,85,end,489,"","#e74c3c",3,0);					// Draw box
				j=100;
				if (end-start < 16)			j=0;
				else if (end-start < 64)	j=5;
				else if (end-start < 128)	j=10;
				else if (end-start < 192)	j=20;
				DrawText(x,460,"#e74c3c",12,ShortenString(o[i].d2,j),"middle").setAttribute("font-weight","bold");
				DrawText(x,475,"#e74c3c",12,ShortenString(o[i].d3,j),"middle").setAttribute("font-weight","bold");;
				}
			else if (o[i].d1 == "Student actions") {						// Student actions	
				DrawBox(start,416,end,435,"#999","#fff",1.5,3);				// Draw bar
				DrawText(x,430,"#fff",12,o[i].d2,"middle");					// Draw action
				}
			else if (o[i].d1 == "Event") {									// Events	
				for (j=0;j<dataLabCats.length;++j)							// For each media type
					if (o[i].d2 == dataLabCats[j]) {						// Matches
						y=242+(j*20);										// Set pos
						break;												// Quit
						}
				p=DrawBox(start,y,start+8,y+8,"#e67e22","",0,8);			// Draw circle
/*				p.setAttribute("id","dot-"+i);								// Id
				$("#dot-"+i).on("mouseover", function(e) { 					// On click
					var id=e.target.id.substr(4);							// Get id
					trace(obsEvents[id].d3);
					});
*/				}
			else if (o[i].d1 == "Visual Aid") {								// Visual Aid	
				for (j=0;j<dataMedia.length;++j)							// For each media type
					if (o[i].d2 == dataMedia[j]) {							// Matches
						y=103+(j*20);										// Set pos
						DrawBox(start,y,end,y+5,"#27ae60","",0,5);			// Draw bar
						break;												// Quit
						}
				}
			}
		DrawLine(xs,ys,"#ccc",5).setAttribute("stroke-dasharray","5,5");	// Draw engagement line
	}

	function ShowData()														// SHOW DATA
	{
		var i
		var str="<div><table>"
		str+="<tr><td><b>Session Id:</b></td><td>"+curJson.id+"<td></tr>";
		str+="<tr><td><b>Observer:</b></td><td>"+curJson.obs+"<td></tr>";
		str+="<tr><td><b>Observer email:&nbsp;&nbsp;</b></td><td>"+curJson.email+"<td></tr>";
		str+="<tr><td><b>Teacher Id:</b></td><td>"+curJson.teacherId+"<td></tr>";
		str+="<tr><td><b>Grade:</b></td><td>"+curJson.grade+"<td></tr>";
		str+="<tr><td><b>Subject:</b></td><td>"+curJson.subject+"<td></tr>";
		str+="<tr><td><b>Date:</b></td><td>"+curJson.date+"<td></tr>";
		str+="<tr><td><b>Block:</b></td><td>"+curJson.block+"<td></tr>";
		str+="<tr><td><b>Setting:</b></td><td>"+curJson.setting+"<td></tr>";
		str+="<tr><td><b>Video:</b></td><td>"+curJson.video+"<td></tr>";
		str+="<tr><td><b>Reminder:</b></td><td>"+curJson.remind+"<td></tr>";
		str+="</table></div><br>";
		$("#dataPanel").append(str);										// Add to panel										
	}

	function GetPixFromTime(time)											// GET TIMELINE POSITION FROM TIME
	{
		return time*scaleSpan/60+8;												// Get pixels
	}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// SVG
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function DrawLine(x, y, col, wid) 									// DRAW SVG LINE
	{
		var i;
		var o=document.createElementNS(svgNS,"path");						// Create element
		var str="M"+x[0]+" "+y[0];											// Start
		for (i=1;i<x.length;++i) {											// For each coord
			str+="L";														// Line to
			str+=x[i]+",";													// Pos x
			str+=y[i]+" ";													// Pos y
			}
		o.setAttribute("d",str);											// Add coords to line
		o.setAttribute("stroke-width",wid+"px");							// Stroke width 
		o.style.fill="none";												// No fill	
		o.style.stroke=col;  												// Stroke color
		svg.appendChild(o);													// Add element to DOM
		return o;															// Return pointer to element
}

	function DrawText(x, y, col, size, text, align) 					// DRAW SVG TEXT
	{
		var o=document.createElementNS(svgNS,"text");						// Create element
		o.setAttribute("x",x);												// X
		o.setAttribute("y",y);												// Y
		o.setAttribute("fill",col);											// Col
		o.setAttribute("font-size",size);									// Size
		o.setAttribute("font-family","sans-serif");							// Font
		if (align)															// If aligning
			o.setAttribute("text-anchor",align);							// Align
		svg.appendChild(o);													// Add element to DOM
		$(o).css("user-select","none");										// No select
		$(o).text(text);													// Text
		return o;															// Return pointer to element
		}

	function DrawBox(x1, y1, x2, y2, col, ecol, ewid, rad) 				// DRAW SVG BOX
	{
		var o=document.createElementNS(svgNS,"rect");						// Create element
		o.setAttribute("height",Math.abs(y2-y1));							// Height
		o.setAttribute("width",Math.abs(x2-x1));							// Width
		o.setAttribute("x",x1);												// X
		o.setAttribute("y",y1);												// Y
		if (rad) {															// If rounded
			o.setAttribute("rx",rad);										// Set X radius
			o.setAttribute("ry",rad);										// Y
			}
		if (ewid) {
			o.style.stroke=ecol;  											// Stroke color
			o.setAttribute("stroke-width",ewid+"px");						// Stroke width 
			}
		else
			o.style.stroke="none";											// No edge	
		if (col) 
			o.style.fill=col;  												// Fill color
		else
			o.style.fill="none";											// No fill	
		svg.appendChild(o);													// Add element to DOM
		return o;															// Return pointer to element
	}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


	function Query(query, callback) 
	{
		var dat={ q:query.replace(/'/g,"~") };
		var url="//classroomteachingscan.com/ctscan/query.php";				// Target
		$.ajax({ url:url,dataType:'text',type:"GET",crossDomain:true,data:dat,  // Get data
			success:function(d) { callback(d) },							// Run callback				
			error:function(xhr,status,error) { trace(error) },				// Show error
			});		
	}
		
	function GetTextBox(title, content, def, callback)					// GET TEXT LINE BOX
	{
		$("#alertBoxDiv").remove();											// Remove any old ones
		$("body").append("<div class='unselectable' id='alertBoxDiv'></div>");														
		var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span class='ct-dialogTitle'>"+title+"</span><p>";
		str+="<div style='font-size:12px;margin:14px'>"+content;
		str+="<p><input class='ct-is' type='text' id='gtBoxTt' value='"+def+"'></p>";
		str+="<div id='dialogOK' class='ct-but'>OK</div>";
		str+="<div id='dialogCancel' class='ct-but' style='margin-left:8px;background-color:#990000'>Cancel</div></div>";
		
		$("#alertBoxDiv").append(str);	
		$("#alertBoxDiv").dialog({ width:500 });	
		$("#alertBoxDiv").dialog("option","position",{ my:"center", at:"center", of:viewPanel });
		$("#alertBoxDiv").css({ border:"1px solid #990000","border-radius":"6px"});

		$("#dialogOK").on("click", function() {								// ON OK BUT
					callback($("#gtBoxTt").val());
					$("#alertBoxDiv").remove();  
				});

		$("#dialogCancel").on("click", function() {							// ON CANCEL BUT
				$("#alertBoxDiv").remove();									// Remove 
				Sound("delete");											// Delete sound
			});
		}

	function ShortenString(str, len)									// SHORTEN A STRING TO LENGTH
	{
		if (!len)															// No length
			return "";														// Return null
		if (str && str.length > len)										// Too long
			str=str.substr(0,(len-3)/2)+"..."+str.slice((len-3)/-2);		// Shorten	
		return str;															// Return string
	}

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function Sound(sound, mute)												// PLAY SOUND
	{
		var snd=new Audio();													// Init audio object
		if (!snd.canPlayType("audio/mpeg") || (snd.canPlayType("audio/mpeg") == "maybe")) 
			snd=new Audio("img/"+sound+".ogg");									// Use ogg
		else	
			snd=new Audio("img/"+sound+".mp3");									// Use mp3
		if (!mute)	{															// If not initing or muting	
			snd.volume=50/100;													// Set volume
			snd.play();															// Play it
			}
		}
	
</script>
</body>
</html>
